<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <link rel="stylesheet" href="./style.css">
        <meta charset="utf-8">
        <title>KLO-Pokebase</title>
    </head>
    <body>
        <div id="popupContainerContainer" style="display: none; transform: scale(0.75);">
            <div id="popupContainer">
                <div id="PokemonPanelContainer">
                    <div id="InfoPanel">
                        <div id="PokepicContainer">
                            <button type="button" name="flipButton"></button>
                            <img src="./img/sprites/forward/1.png" alt="">
                        </div>
                        <div id="NameContainer">
                            <h2>#001 Bulbasaur</h2>
                        </div>
                        <div id="TypeContainer">
                            <h2>Grass</h2>
                            <h2>Poison</h2>
                        </div>
                        <div id="InfoContainer">
                            <p>Weight: 0kg</p>
                            <p>Height: 0m</p>
                            <p>Color: Green</p>
                            <p>Footprint: <img src="./img/footprints/1.png" alt=""></p>
                            <p>Bodytype: <img src="./img/bodytypes/Body08.png" alt=""></p>
                        </div>
                        <div id="CryContainer">
                            <audio controls src="./aud/cries/1.ogg" type="audio/ogg"> </audio>
                        </div>
                    </div>

                    <div id="StatPanel">
                        <table id="statTable">
                            <tr>
                                <td>HP:</td>
                                <td>45</td>
                            </tr>
                            <tr>
                                <td>Attack:</td>
                                <td>49</td>
                            </tr>
                            <tr>
                                <td>Defense:</td>
                                <td>49</td>
                            </tr>
                            <tr>
                                <td>Sp. Attack:</td>
                                <td>65</td>
                            </tr>
                            <tr>
                                <td>Sp. Defense:</td>
                                <td>65</td>
                            </tr>
                            <tr>
                                <td>Speed:</td>
                                <td>45</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <button type="button" name="closeButton" id="closeInfoButton">X</button>
                <button type="button" name="nextPokemon" id="nextInfoButton">></button>
                <button type="button" name="previousPokemon" id="previousInfoButton"><</button>
            </div>
        </div>

        <div id="PanelContainer">
            <div id="ListContainer">
                <h1 id="placeholderHeader">Fetching Pok√©mon...</h1>
                <p id="placeholderText">This page requires JavaScript to function. If it is disabled, no functionality will be available</p>
            </div>
            <div id="SearchContainer">
                <h1 class="Underline">Search</h1>
                <input type="text" name="SearchBox" value="" id="SearchBar">
                <p>Press enter to filter</p>
                <h2 class="Underline">Sort by</h2>
                <div id="SortByContainer">
                    <button type="button" name="SortNum" id="SortActive">Num</button>
                    <button type="button" name="SortName">Name</button>
                    <button type="button" name="SortWeight">Weight</button>
                </div>
                <h2 class="Underline">Filters</h2>
                <h3>Types</h3>
                <div id="TypeGridContainer">
                    <input type="checkbox" name="water" id="water">
                    <label for="water">Water</label>
                    <input type="checkbox" name="normal" id="normal">
                    <label for="normal">Normal</label>
                    <input type="checkbox" name="flying" id="flying">
                    <label for="flying">Flying</label>
                    <input type="checkbox" name="grass" id="grass">
                    <label for="grass">Grass</label>
                    <input type="checkbox" name="psychic" id="psychic">
                    <label for="psychic">Psychic</label>
                    <input type="checkbox" name="bug" id="bug">
                    <label for="bug">Bug</label>
                    <input type="checkbox" name="fire" id="fire">
                    <label for="fire">Fire</label>
                    <input type="checkbox" name="poison" id="poison">
                    <label for="poison">Poison</label>
                    <input type="checkbox" name="ground" id="ground">
                    <label for="ground">Ground</label>
                    <input type="checkbox" name="rock" id="rock">
                    <label for="rock">Rock</label>
                    <input type="checkbox" name="fighting" id="fighting">
                    <label for="fighting">Fighting</label>
                    <input type="checkbox" name="dark" id="dark">
                    <label for="dark">Dark</label>
                    <input type="checkbox" name="steel" id="steel">
                    <label for="steel">Steel</label>
                    <input type="checkbox" name="electric" id="electric">
                    <label for="electric">Electric</label>
                    <input type="checkbox" name="dragon" id="dragon">
                    <label for="dragon">Dragon</label>
                    <input type="checkbox" name="fairy" id="fairy">
                    <label for="fairy">Fairy</label>
                    <input type="checkbox" name="ghost" id="ghost">
                    <label for="ghost">Ghost</label>
                    <input type="checkbox" name="ice" id="ice">
                    <label for="ice">Ice</label>
                </div>
                <button class="resetButton" id="TypeUnfilterButton">Unfilter</button>

                <h3>Color</h3>
                <div id="ColorContainer">
                    <input type="radio" name="color" id="red">
                    <input type="radio" name="color" id="blue">
                    <input type="radio" name="color" id="yellow">
                    <input type="radio" name="color" id="green">
                    <input type="radio" name="color" id="black">
                    <input type="radio" name="color" id="brown">
                    <input type="radio" name="color" id="purple">
                    <input type="radio" name="color" id="gray">
                    <input type="radio" name="color" id="white">
                    <input type="radio" name="color" id="pink">
                </div>
                <button class="resetButton" id="colorUnfilterButton">Unfilter</button>
                <h3>Body type</h3>
                <div id="BodyTypeContainer">
                    <input type="radio" name="bodyType" id="head">
                    <label for="head">
                        <img src="./img/bodytypes/Body01.png">
                    </label>
                    <input type="radio" name="bodyType" id="headAndLegs">
                    <label for="headAndLegs">
                        <img src="./img/bodytypes/Body07.png">
                    </label>
                    <input type="radio" name="bodyType" id="fins">
                    <label for="fins">
                        <img src="./img/bodytypes/Body03.png">
                    </label>
                    <input type="radio" name="bodyType" id="insect">
                    <label for="insect">
                        <img src="./img/bodytypes/Body14.png">
                    </label>
                    <input type="radio" name="bodyType" id="quadruped">
                    <label for="quadruped">
                        <img src="./img/bodytypes/Body08.png">
                    </label>
                    <input type="radio" name="bodyType" id="multipleWings">
                    <label for="multipleWings">
                        <img src="./img/bodytypes/Body13.png">
                    </label>
                    <input type="radio" name="bodyType" id="multiple">
                    <label for="multiple">
                        <img src="./img/bodytypes/Body11.png">
                    </label>
                    <input type="radio" name="bodyType" id="multiped">
                    <label for="multiped">
                        <img src="./img/bodytypes/Body10.png">
                    </label>
                    <input type="radio" name="bodyType" id="headAndBase">
                    <label for="headAndBase">
                        <img src="./img/bodytypes/Body05.png">
                    </label>
                    <input type="radio" name="bodyType" id="bipedWithTail">
                    <label for="bipedWithTail">
                        <img src="./img/bodytypes/Body06.png">
                    </label>
                    <input type="radio" name="bodyType" id="bipedNoTail">
                    <label for="bipedNoTail">
                        <img src="./img/bodytypes/Body12.png">
                    </label>
                    <input type="radio" name="bodyType" id="oneWings">
                    <label for="oneWings">
                        <img src="./img/bodytypes/Body09.png">
                    </label>
                    <input type="radio" name="bodyType" id="serpentine">
                    <label for="serpentine">
                        <img src="./img/bodytypes/Body02.png">
                    </label>
                    <input type="radio" name="bodyType" id="headAndArms">
                    <label for="headAndArms">
                        <img src="./img/bodytypes/Body04.png">
                    </label>
                </div>
                <button class="resetButton" id="BodyTypeUnfilterButton">Unfilter</button>
            </div>
        </div>
        <template id="pokemonCardTemplate">
            <div class="pokeCard" id="1">
                <img src="./img/sprites/forward/1.png" class id="pokeCardImage"/>
                <p id="pokeCardText">#001 Bub</p>
            </div>
        </template>

    </body>
    <script type="text/javascript">

        var pokemonListContainer = document.getElementById("ListContainer");
        var cardTemplate = document.getElementById("pokemonCardTemplate");
        var Pokemon = [] = Array(152);
        const request = async() => {
            var urls = Array(151);
            for (var i = 0; i < 151; i++) {
                urls[i] = "dex/" + (i+1);
            }

            //https://stackoverflow.com/questions/31710768/how-can-i-fetch-an-array-of-urls-with-promise-all
            var promises = urls.map(url => fetch(url).then(y => y.text()));
            Promise.all(promises).then(results => {
                pokemonListContainer.innerHTML = "";
                for (var i = 1; i < 152; i++) {
                    Pokemon[i] =  JSON.parse(results[i-1]);
                    var templateCopy = document.importNode(cardTemplate.content, true);
                    templateCopy.getElementById("1").id = i;
                    templateCopy.getElementById("pokeCardImage").src = "./img/sprites/forward/" + i + ".png";
                    templateCopy.getElementById("pokeCardImage").id = "";
                    templateCopy.getElementById("pokeCardText").textContent = "#" + i + " - " + Pokemon[i]["name"];
                    templateCopy.getElementById("pokeCardText").id = "";
                    pokemonListContainer.appendChild(templateCopy);
                }
            });
        }
        request();


        var typeGridResetButton = document.getElementById("TypeUnfilterButton");
        typeGridResetButton.onclick = unfilterTypeGrid;

        function unfilterTypeGrid() {
            var un = document.getElementById('TypeGridContainer').getElementsByTagName("input");
            for (var i = 0; i < un.length; i++) {
              un[i].checked = false;
            }
        }

        var ColorResetButton = document.getElementById("colorUnfilterButton");
        ColorResetButton.onclick = unfilterColor;

        function unfilterColor() {
            var un = document.getElementById('ColorContainer').getElementsByTagName("input");
            for (var i = 0; i < un.length; i++) {
              un[i].checked = false;
            }
        }

        var BodyTypeResetButton = document.getElementById("BodyTypeUnfilterButton");
        BodyTypeResetButton.onclick = unfilterBodyType;

        function unfilterBodyType() {
            var un = document.getElementById('BodyTypeContainer').getElementsByTagName("input");
            for (var i = 0; i < un.length; i++) {
              un[i].checked = false;
            }
        }

        /*function SearchBarFilter(){
            var input, filter, a, x, y, z, text;
            input = document.getElementById("SearchContainer")
            filter = input.value.toUpperCase();
            a = document.getElementById("")
        }*/

        var SearchBar = document.getElementById("SearchBar");
        SearchBar.addEventListener("change", SearchbarFill);

        var TypeFilter = document.getElementById("TypeGridContainer");
        TypeFilter.onclick = SearchbarFill;

        var ColorFilter = document.getElementById("ColorContainer");
        ColorFilter.addEventListener("change", SearchbarFill);

        var BodytypeFilter = document.getElementById("BodyTypeContainer");
        BodytypeFilter.addEventListener("change", SearchbarFill);

        function SearchbarFill(e){
            var SearchbarFilterList = [];
            var TypeFilter = [];
            var typeButtons = document.getElementById('TypeGridContainer').getElementsByTagName("input");
            for (var i = 0; i < typeButtons.length; i++) {
                if(typeButtons[i].checked == true) {
                    TypeFilter.push(typeButtons[i].id);
                }
            }
            for (var i = 0; i < 151; i++){
                if (Pokemon[i+1]["name"].includes(SearchBar.value)) {
                    SearchbarFilterList.push(i+1);
                }
            }
            for (var i = SearchbarFilterList.length-1; i >= 0; i--){
                if (TypeFilter.length == 1){
                    if (!Pokemon[SearchbarFilterList[i]]["types"].includes(TypeFilter[0])){
                        SearchbarFilterList.splice(i,1);
                    }
                }
                else if (TypeFilter.length == 2) {
                    if (Pokemon[SearchbarFilterList[i]]["types"].toString() != TypeFilter.toString()){
                        SearchbarFilterList.splice(i,1);
                    }
                }
                else if (TypeFilter.length > 2){
                    SearchbarFilterList = [];
                }
            }
            var color = document.querySelector('input[name="color"]:checked');
            for (var i = SearchbarFilterList.length-1; i >= 0; i--){
                if (color != null) {
                    if (!Pokemon[SearchbarFilterList[i]]["color"] == color.id){
                        SearchbarFilterList.splice(i,1);
                    }
                }
            }
            var bodyType = document.querySelector('input[name="bodyType"]:checked');
            for (var i = SearchbarFilterList.length-1; i >= 0; i--){
                if(bodyType != null) {
                    if (!Pokemon[SearchbarFilterList[i]]["bodyType"] == bodyType.id){
                        var removed = SearchbarFilterList.splice(i,1);
                    }
                }
            }
            for (var i = 1; i < 152; i++){
                find = document.getElementById(i);
                if (SearchbarFilterList.includes(i)){
                    find.style.display = "";
                    }else{
                        find.style.display = "none";
                    }
                }
            console.log(SearchbarFilterList);
        }

        function sortPokecards(method, direction) {
            var sort = [];
            if (method == "name") {
                for (var i = 1; i < 152; i++) {
                    sort.push([Pokemon[i].name, i]);
                }
                sort.sort(function(a,b){
                    if(a[0] < b[0]) { return -1;}
                    if(a[0] > b[0]) { return 1; }
                    return 0;
                });
            }
            else if(method == "weight") {
                for (var i = 1; i < 152; i++) {
                    sort.push([Pokemon[i].weight, i]);
                }
                sort.sort(function(a,b){
                    if(a[0] < b[0]) { return -1;}
                    if(a[0] > b[0]) { return 1; }
                    return 0;
                });
            }
            if(direction == "reverse") {
                sort = sort.reverse();
            }
            for (var i = 0; i < 151; i++) {
                pokemonListContainer.children[i].style.order = sort[i][0];
            }
        }

        var PopupContainer = document.getElementById("popupContainerContainer");
        var pokePic = document.getElementById('PokepicContainer').getElementsByTagName('img');
        var pokeName = document.getElementById('NameContainer').getElementsByTagName('h2');
        var typeContainer = document.getElementById('TypeContainer');
        var infoContainer = document.getElementById('InfoContainer');
        var cry = document.getElementById('CryContainer').getElementsByTagName('audio');
        var statTable = document.getElementById('statTable');
        var stats = ["hp", "attack", "defense", "special-attack", "special-defense", "speed"];
        var colors = ["rgb(255, 0, 0)", "rgb(240, 128, 48)", "rgb(248, 208, 48)", "rgb(104, 144, 240)", "rgb(120, 200, 80)", "rgb(248, 88, 136)"];
        function showInfoPanel(i) {
            pokePic[0].src = "./img/sprites/forward/" + i + ".png";
            pokeName[0].textContent = "#" + i + " " + Pokemon[i]["name"].toUpperCase();
            typeContainer.innerHTML = "";
            for(var type in Pokemon[i]["types"]) {
                typeContainer.innerHTML = typeContainer.innerHTML + "<h2>" + Pokemon[i]["types"][type].toUpperCase() + "</h2>";
            }
            infoContainer.children[0].textContent = "Weight: " + parseFloat(Pokemon[i]["weight"] / 10).toFixed(2);
            infoContainer.children[1].textContent = "Height: " + parseFloat(Pokemon[i]["height"] / 10).toFixed(2);
            infoContainer.children[2].textContent = "Color: " + Pokemon[i]["color"].toUpperCase();
            infoContainer.children[3].children[0].src = "./img/footprints/" + i + ".png";
            cry[0].src = "./aud/cries/" + i + ".ogg";
            cry[0].load();
            for(var o = 0; o < 6; o++) {
                statTable.children[0].children[o].children[1].textContent = Pokemon[i]["stats"][stats[o]];
                statTable.children[0].children[o].children[1].style.background = "-webkit-linear-gradient(left, " + colors[o] + " " + (Pokemon[i]["stats"][stats[o]] / 255 * 100) + "%, rgba(0,0,0,0) 0%)";
            }
            PopupContainer.style.display = "";
            PopupContainer.style.transform = "";
        }

        var CloseButton = document.getElementById("closeInfoButton");
        CloseButton.onclick = closeInfoPanel;

        function closeInfoPanel() {
            PopupContainer.style.display = "none";
            PopupContainer.style.transform = "scale(0.85)"
        }

        pokemonListContainer.addEventListener("click", clickListItem);
        function clickListItem(event) {
            for(i = 0; i < event.composedPath().length; i++) {
                if(event.composedPath()[i].className == "pokeCard") {
                    showInfoPanel(event.composedPath()[i].id);
                    break;
                }
            }
        }
    </script>
</html>
